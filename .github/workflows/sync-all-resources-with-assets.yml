name: ÂêåÊ≠•ÊâÄÊúâËµÑÊ∫êÔºà‰ª£Á†Å + Tags + Releases + ÈôÑ‰ª∂Ôºâ

on:
  workflow_dispatch:   # ÊâãÂä®Ëß¶Âèë
  # schedule:
  #   - cron: '0 0 * * *'  # ÂèØÈÄâÔºöÂÆöÊó∂Ëß¶Âèë

jobs:
  sync-releases-and-assets:
    runs-on: ubuntu-latest

    steps:
      - name: ‰∏ÄÈîÆÂêåÊ≠•ÊâÄÊúâËµÑÊ∫ê
        env:
          SOURCE_REPO: Licoy/wordpress-theme-puock
          TARGET_REPO: wuyueerhao/wordpress-theme-puock
          GITHUB_TOKEN: ${{ secrets.MY_GIT_TOKEN }}
        run: |
          echo "Fetching releases from $SOURCE_REPO ..."
          RELEASES=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            https://api.github.com/repos/$SOURCE_REPO/releases)

          # Ê£ÄÊü•ÊòØÂê¶ËøîÂõû‰∫ÜÊúâÊïàÁöÑ Releases ÂàóË°®
          echo "$RELEASES" | jq -e 'type == "array"' >/dev/null 2>&1
          if [ $? -ne 0 ]; then
            echo "‚ùå ÈîôËØØÔºöÊú™ËÉΩËé∑ÂèñÂà∞ÊúâÊïàÁöÑ Releases ÂàóË°®ÔºåËøîÂõûÂÜÖÂÆπÂèØËÉΩ‰∏∫Á©∫Êàñ‰∏çÊòØÊï∞ÁªÑ„ÄÇ"
            echo "$RELEASES"
            exit 1
          fi

          echo "$RELEASES" | jq -c '.[]' | while read -r release; do
            TAG_NAME=$(echo "$release" | jq -r '.tag_name')
            NAME=$(echo "$release" | jq -r '.name')
            BODY=$(echo "$release" | jq -r '.body')
            DRAFT=$(echo "$release" | jq -r '.draft')
            PRERELEASE=$(echo "$release" | jq -r '.prerelease')
            RELEASE_ID_ORIGINAL=$(echo "$release" | jq -r '.id')

            echo "üîÅ Processing Release: $NAME (Tag: $TAG_NAME)"

            # Step 1: Âú®‰Ω†ÁöÑ Fork ‰∏≠ÂàõÂª∫ Release
            echo "üÜï Creating Release on your fork..."
            CREATED_RELEASE=$(curl -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/$TARGET_REPO/releases \
              -d '{
                "tag_name": "'"$TAG_NAME"'",
                "name": "'"$NAME"'",
                "body": "'"$BODY"'",
                "draft": '$DRAFT',
                "prerelease": '$PRERELEASE'
              }')

            # Ê£ÄÊü•ÊòØÂê¶ÂàõÂª∫ÊàêÂäü
            echo "$CREATED_RELEASE" | jq -e 'has("id")' >/dev/null 2>&1
            if [ $? -ne 0 ]; then
              echo "‚ùå ÂàõÂª∫ Release Â§±Ë¥•ÔºåËøîÂõûÂÜÖÂÆπÔºö"
              echo "$CREATED_RELEASE"
              echo "‚è© Ë∑≥ËøáÊ≠§ Release ÁöÑÈôÑ‰ª∂ÂêåÊ≠•"
              continue
            fi

            UPLOAD_URL=$(echo "$CREATED_RELEASE" | jq -r '.upload_url' | sed 's/{?name,label}//')
            RELEASE_ID=$(echo "$CREATED_RELEASE" | jq -r '.id')

            echo "‚úÖ Created Release ID: $RELEASE_ID"
            echo "üì§ Upload URL Base: $UPLOAD_URL"

            # Step 2: Ëé∑ÂèñËØ• Release ÁöÑÊâÄÊúâÈôÑ‰ª∂
            ASSETS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              https://api.github.com/repos/$SOURCE_REPO/releases/$RELEASE_ID_ORIGINAL/assets)

            echo "$ASSETS" | jq -c '.[]' | while read -r asset; do
              ASSET_NAME=$(echo "$asset" | jq -r '.name')
              ASSET_URL=$(echo "$asset" | jq -r '.url')
              ASSET_ID=$(echo "$asset" | jq -r '.id')
              CONTENT_TYPE=$(echo "$asset" | jq -r '.content_type')
              DOWNLOAD_URL=$(echo "$asset" | jq -r '.browser_download_url')

              echo "‚¨áÔ∏è  Downloading Asset: $ASSET_NAME..."

              curl -s -L -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/octet-stream" \
                "$DOWNLOAD_URL" -o "/tmp/$ASSET_NAME"

              echo "üì§ Uploading Asset: $ASSET_NAME to your Release..."
              curl -X POST \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Content-Type: $CONTENT_TYPE" \
                --data-binary @"/tmp/$ASSET_NAME" \
                "${UPLOAD_URL}?name=${ASSET_NAME}"

              echo "‚úÖ Uploaded: $ASSET_NAME"
              echo "--------------------------------------------------"
            done

          done
