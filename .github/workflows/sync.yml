name: Auto Sync Fork (Code + Tags + Releases)

on:
  schedule:
    - cron: "0 */6 * * *"   # ÊØè 6 Â∞èÊó∂ÂêåÊ≠•‰∏ÄÊ¨°
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout fork repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # -------------------------------------------------------
      # üî• ÊúÄÂÖ≥ÈîÆÈÉ®ÂàÜÔºöÂΩªÂ∫ï‰øÆÂ§ç remoteÔºåËß£ÂÜ≥‰Ω†ÈÅáÂà∞ÁöÑ 403 ÈóÆÈ¢ò
      # -------------------------------------------------------
      - name: Reset remotes correctly
        run: |
          echo "=== Before reset ==="
          git remote -v
      
          # Âà†Èô§ÊâÄÊúâËøúÁ®ã‰ªìÂ∫ì
          for r in $(git remote); do
            git remote remove $r || true
          done
      
          echo "=== After remove ==="
          git remote -v
      
          # Ê∑ªÂä† originÔºà‰Ω†ÁöÑ fork ‰ªìÂ∫ìÔºåËá™Âä®Â∞±ÊòØÂΩìÂâç‰ªìÂ∫ìÔºåÈÄöÂ∏∏‰∏çÈúÄË¶ÅÊâãÂä®Âä†Ôºâ
          # ‰ΩÜ‰∏∫‰∫ÜÁªü‰∏ÄÔºåÂèØ‰ª•ÊòæÂºèËÆæÁΩÆ
          git remote add origin https://github.com/${{ github.repository }}.git
      
          # Ê∑ªÂä† upstreamÔºàÂéü‰ªìÂ∫ì Licoy/wordpress-theme-puockÔºâ
          git remote add upstream https://github.com/Licoy/wordpress-theme-puock.git
      
          echo "=== Final remotes ==="
          git remote -v

      # -------------------------------------------------------
      # ÂêåÊ≠•‰ª£Á†Å (master)
      # -------------------------------------------------------
      - name: Fetch upstream
        run: git fetch upstream

      - name: Merge upstream/master ‚Üí fork/master
        run: |
          git checkout master
          git merge upstream/master --allow-unrelated-histories -X theirs || true
          git push origin master || true

      # -------------------------------------------------------
      # ÂêåÊ≠• tags
      # -------------------------------------------------------
      - name: Sync tags
        run: |
          git fetch upstream --tags
          git push origin --tags

      # -------------------------------------------------------
      # ÂêåÊ≠• ReleasesÔºàÂåÖÊã¨ÊâÄÊúâ assetsÔºâ
      # -------------------------------------------------------

      - name: Get latest upstream release
        id: upstream_release
        run: |
          latest=$(curl -s https://api.github.com/repos/Licoy/wordpress-theme-puock/releases/latest | jq -r '.tag_name')
          echo "latest_tag=$latest" >> $GITHUB_OUTPUT

      - name: Check if release exists in fork
        id: release_exists
        run: |
          fork_release=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ steps.upstream_release.outputs.latest_tag }} | jq -r '.tag_name')
          if [[ "$fork_release" == "${{ steps.upstream_release.outputs.latest_tag }}" ]]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create missing release in fork (with assets)
        if: steps.release_exists.outputs.exists == 'false'
        run: |
          upstream_api="https://api.github.com/repos/Licoy/wordpress-theme-puock/releases/latest"

          # release ‰ø°ÊÅØ
          body=$(curl -s $upstream_api | jq -r '.body')
          tag=$(curl -s $upstream_api | jq -r '.tag_name')
          name=$(curl -s $upstream_api | jq -r '.name')

          echo "Creating release: $tag"

          # ÂàõÂª∫ release
          release_id=$(curl -s \
            -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"tag_name\":\"$tag\",\"name\":\"$name\",\"body\":\"$body\",\"draft\":false,\"prerelease\":false}" \
            https://api.github.com/repos/${{ github.repository }}/releases \
            | jq -r '.id')

          echo "Created release ID: $release_id"

          # ‰∏ãËΩΩ & ‰∏ä‰º† assets
          assets=$(curl -s $upstream_api | jq -c '.assets[]')
          for asset in $assets; do
            url=$(echo "$asset" | jq -r '.browser_download_url')
            filename=$(echo "$asset" | jq -r '.name')

            echo "Downloading asset: $filename"
            curl -L -o "$filename" "$url"

            echo "Uploading asset: $filename"
            curl -s \
              -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/octet-stream" \
              --data-binary @"$filename" \
              https://uploads.github.com/repos/${{ github.repository }}/releases/$release_id/assets?name=$filename
          done
