name: Sync Fork & Releases

on:
  schedule:
    - cron: "0 3 * * *"   # 每天凌晨 3 点自动同步
  workflow_dispatch:       # 手动执行
  push:
    branches: [ main ]

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Setup Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: Add upstream
      run: |
        git remote add upstream https://github.com/Licoy/wordpress-theme-puock.git
        git fetch upstream

    - name: Merge upstream changes
      run: |
        git checkout main
        git merge upstream/main --allow-unrelated-histories || true

    - name: Push changes to origin
      run: |
        git push origin main || true

    - name: Sync tags from upstream
      run: |
        git fetch upstream --tags
        git push origin --tags || true

    # ----- 同步 Releases -----

    - name: Install GitHub CLI
      run: |
        sudo apt update
        sudo apt install -y gh

    - name: Login to GitHub CLI
      run: gh auth login --with-token <<< "$GH_TOKEN"
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}

    - name: Get release list from upstream
      id: list
      run: |
        gh release list -R Licoy/wordpress-theme-puock --limit 100 > releases.txt
        cat releases.txt
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}

    - name: Sync each release
      run: |
        while read -r line; do
          TAG=$(echo $line | awk '{print $1}')
          echo ">>> Processing release: $TAG"

          # 如果 fork 已有该 release，跳过
          gh release list -R $GITHUB_REPOSITORY | grep -q "$TAG" && {
            echo "Release $TAG already exists, skipping."
            continue
          }

          # 下载 upstream release assets
          mkdir -p temp_assets
          gh release download "$TAG" -R Licoy/wordpress-theme-puock -D temp_assets

          # 获取 release 描述
          BODY=$(gh release view "$TAG" -R Licoy/wordpress-theme-puock --json body -q ".body")

          # 创建 release 到 fork
          gh release create "$TAG" temp_assets/* \
            --notes "$BODY" \
            -R $GITHUB_REPOSITORY

          rm -rf temp_assets
        done < releases.txt
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
