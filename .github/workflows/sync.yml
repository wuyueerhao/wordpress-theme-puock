name: Sync Fork & Releases

on:
  schedule:
    - cron: "0 3 * * *"   # 每天凌晨 3 点自动同步
  workflow_dispatch:       # 允许手动执行

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:

    - name: Checkout origin
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Setup Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: Add upstream
      run: |
        git remote add upstream https://github.com/原作者/原仓库.git
        git fetch upstream

    - name: Checkout master branch
      run: git checkout master

    - name: Merge upstream master
      run: |
        git merge upstream/master --allow-unrelated-histories || true

    - name: Push merged changes
      run: |
        git push origin master || true

    - name: Sync tags from upstream
      run: |
        git fetch upstream --tags
        git push origin --tags || true

    # ----- 同步 Releases -----

    - name: Install GitHub CLI
      run: |
        sudo apt update
        sudo apt install -y gh

    - name: Authenticate GH CLI
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
      run: |
        gh auth login --with-token <<< "$GH_TOKEN"

    - name: Fetch upstream releases list
      id: list
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
      run: |
        gh release list -R 原作者/原仓库 --limit 100 > releases.txt
        cat releases.txt

    - name: Sync each release
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
      run: |
        while read -r line; do
          TAG=$(echo $line | awk '{print $1}')
          echo ">>> Processing release: $TAG"

          # 如果 Fork 已有对应 release → 跳过
          gh release list -R $GITHUB_REPOSITORY | grep -q "$TAG" && {
            echo "Release $TAG exists → skipping."
            continue
          }

          echo "Syncing Release $TAG ..."

          # 下载 upstream release assets
          mkdir -p assets
          gh release download "$TAG" -R 原作者/原仓库 -D assets

          # 获取 release 说明
          BODY=$(gh release view "$TAG" -R 原作者/原仓库 --json body -q ".body")

          # 创建 release 到 fork
          gh release create "$TAG" assets/* \
            --notes "$BODY" \
            -R $GITHUB_REPOSITORY \
            || echo "No assets for $TAG"

          rm -rf assets
        done < releases.txt
