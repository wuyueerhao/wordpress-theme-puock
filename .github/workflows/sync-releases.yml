name: Sync Releases from Licoy/wordpress-theme-puock to My Fork

on:
  workflow_dispatch:   # 手动触发，推荐先手动测试
  # schedule:
  #   - cron: '0 0 * * *'  # 可选：每天凌晨自动运行一次

jobs:
  sync-releases:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout your fork
        uses: actions/checkout@v4
        with:
          ref: master
          token: ${{ secrets.MY_GIT_TOKEN }}
          fetch-depth: 0

      - name: Set Git Identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch upstream tags (确保本地有所有 tag，可选，但推荐)
        run: |
          git fetch --tags

      - name: Sync Releases using GitHub API
        env:
          SOURCE_REPO: Licoy/wordpress-theme-puock      # 原仓库
          TARGET_REPO: wuyueerhao/wordpress-theme-puock  # 你的 Fork 仓库
          GITHUB_TOKEN: ${{ secrets.MY_GIT_TOKEN }}      # 你的 Personal Access Token，拥有 repo 权限
        run: |
          # 获取原仓库的所有 Releases
          echo "Fetching releases from $SOURCE_REPO ..."
          RELEASES=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            https://api.github.com/repos/$SOURCE_REPO/releases)

          # 遍历每个 Release
          echo "$RELEASES" | jq -c '.[]' | while read -r release; do
            TAG_NAME=$(echo "$release" | jq -r '.tag_name')
            NAME=$(echo "$release" | jq -r '.name')
            BODY=$(echo "$release" | jq -r '.body')
            DRAFT=$(echo "$release" | jq -r '.draft')
            PRERELEASE=$(echo "$release" | jq -r '.prerelease')
            TARGET_TAG="$TAG_NAME"

            echo "Creating Release for TAG: $TARGET_TAG ..."

            # 调用 GitHub API，在你的 Fork 仓库中创建 Release
            curl -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/$TARGET_REPO/releases \
              -d '{
                "tag_name": "'"$TARGET_TAG"'",
                "name": "'"$NAME"'",
                "body": "'"$BODY"'",
                "draft": '$DRAFT',
                "prerelease": '$PRERELEASE'
              }'

            echo "--------------------------------------------------"
          done
